{
  "version": 1,
  "purpose": "Optional, rebuildable DB index schema for kano-agent-backlog-skill (file-first).",
  "source_of_truth": [
    "_kano/backlog/items/**/*.md",
    "_kano/backlog/decisions/**/*.md"
  ],
  "tables": {
    "schema_meta": {
      "description": "Key/value metadata for the index itself.",
      "columns": {
        "key": "TEXT PRIMARY KEY",
        "value": "TEXT NOT NULL"
      },
      "recommended_keys": [
        "schema_version",
        "generated_at_utc",
        "repo_root",
        "backlog_root",
        "process_profile"
      ]
    },
    "items": {
      "description": "Backlog items indexed from Markdown frontmatter.",
      "columns": {
        "id": "TEXT PRIMARY KEY",
        "type": "TEXT NOT NULL",
        "title": "TEXT NOT NULL",
        "state": "TEXT",
        "priority": "TEXT",
        "parent_id": "TEXT (FK -> items.id, ON DELETE SET NULL)",
        "area": "TEXT",
        "iteration": "TEXT",
        "owner": "TEXT",
        "created": "TEXT (ISO date)",
        "updated": "TEXT (ISO date)",
        "source_path": "TEXT NOT NULL (UNIQUE)",
        "content_sha256": "TEXT (optional, for incremental indexing)",
        "frontmatter_json": "TEXT NOT NULL (JSON as text)"
      },
      "indexes": [
        "items.source_path UNIQUE",
        "items.parent_id",
        "items.state",
        "items.type"
      ]
    },
    "item_tags": {
      "description": "Normalized tags for querying and grouping.",
      "columns": {
        "item_id": "TEXT NOT NULL (FK -> items.id, ON DELETE CASCADE)",
        "tag": "TEXT NOT NULL",
        "pk": "(item_id, tag)"
      },
      "indexes": ["item_tags.tag"]
    },
    "item_links": {
      "description": "Normalized link relations from frontmatter links.*.",
      "columns": {
        "item_id": "TEXT NOT NULL (FK -> items.id, ON DELETE CASCADE)",
        "relation": "TEXT NOT NULL (relates|blocks|blocked_by|parent|external|... )",
        "target": "TEXT NOT NULL (item id or external key/url)",
        "pk": "(item_id, relation, target)"
      },
      "indexes": ["item_links.relation", "item_links.target"]
    },
    "item_decisions": {
      "description": "Decision/ADR references linked from item frontmatter decisions[].",
      "columns": {
        "item_id": "TEXT NOT NULL (FK -> items.id, ON DELETE CASCADE)",
        "decision_ref": "TEXT NOT NULL (wikilink target, filename, or URL)",
        "pk": "(item_id, decision_ref)"
      },
      "indexes": ["item_decisions.decision_ref"]
    },
    "worklog_entries": {
      "description": "Parsed Worklog lines (append-only in source).",
      "columns": {
        "id": "INTEGER PRIMARY KEY AUTOINCREMENT",
        "item_id": "TEXT NOT NULL (FK -> items.id, ON DELETE CASCADE)",
        "occurred_at": "TEXT (best-effort timestamp)",
        "agent": "TEXT (from [agent=...])",
        "message": "TEXT NOT NULL",
        "raw_line": "TEXT NOT NULL"
      },
      "indexes": [
        "worklog_entries.item_id",
        "worklog_entries.occurred_at",
        "worklog_entries.agent"
      ]
    }
  },
  "migration_story": "v0/v1: drop and rebuild the index from source files; keep schema versioned via schema_meta.schema_version.",
  "safety": [
    "Indexing must not modify source files.",
    "DB files are artifacts; they can live in backlog_sandbox to avoid git noise."
  ]
}

