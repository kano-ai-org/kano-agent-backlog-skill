============================= test session starts =============================
platform win32 -- Python 3.14.2, pytest-9.0.2, pluggy-1.6.0
rootdir: D:\_work\_Kano\kano-agent-backlog-skill-demo\skills\kano-agent-backlog-skill
configfile: pyproject.toml
testpaths: tests
plugins: anyio-4.12.0, hypothesis-6.150.0, cov-7.0.0
collected 111 items

tests\test_backend_uri.py .............                                  [ 11%]
tests\test_cli_item_create.py .F...                                      [ 16%]
tests\test_config_cli.py .......                                         [ 22%]
tests\test_config_migration.py ....                                      [ 26%]
tests\test_config_overlays.py ...                                        [ 28%]
tests\test_config_toml.py ..........                                     [ 37%]
tests\test_integration_workflow_compatibility.py ..                      [ 39%]
tests\test_snapshot.py .......                                           [ 45%]
tests\test_topic.py ...........................                          [ 70%]
tests\test_topic_lifecycle.py ....                                       [ 73%]
tests\test_workitem_ops.py ..F                                           [ 76%]
tests\test_workset.py ..........................                         [100%]

================================== FAILURES ===================================
____________ test_item_create_creates_file_and_uses_config_prefix _____________

tmp_path = WindowsPath('C:/Users/User/AppData/Local/Temp/pytest-of-dorgon.chang/pytest-54/test_item_create_creates_file_0')

    def test_item_create_creates_file_and_uses_config_prefix(tmp_path: Path):
        backlog_root, product_root = _scaffold_product(tmp_path, name="demo-product")
        cwd_before = Path.cwd()
        os.chdir(tmp_path)
    
        try:
            result = runner.invoke(
                app,
                [
                    "item",
                    "create",
                    "--type",
                    "task",
                    "--title",
                    "Test Task",
                    "--priority",
                    "P2",
                    "--agent",
                    "tester",
                    "--product",
                    "demo-product",
                ],
            )
            assert result.exit_code == 0, result.output
            lines = [line.strip() for line in result.output.splitlines() if line.strip()]
            created_line = next(line for line in lines if line.startswith("OK: Created:"))
            created_id = created_line.split(":", 2)[-1].strip()
>           assert created_id.startswith("DE-TSK-")
E           AssertionError: assert False
E            +  where False = <built-in method startswith of str object at 0x0000020E62085C30>('DE-TSK-')
E            +    where <built-in method startswith of str object at 0x0000020E62085C30> = 'DP-TSK-0001'.startswith

tests\test_cli_item_create.py:85: AssertionError
___________ test_update_state_syncs_parent_and_refreshes_dashboards ___________

tmp_path = WindowsPath('C:/Users/User/AppData/Local/Temp/pytest-of-dorgon.chang/pytest-54/test_update_state_syncs_parent0')

    def test_update_state_syncs_parent_and_refreshes_dashboards(tmp_path: Path):
        product_name = "demo-product"
        product_root = _scaffold_product(tmp_path, name=product_name)
    
        cwd_before = Path.cwd()
        os.chdir(tmp_path)
        try:
            parent = create_item(
                item_type=ItemType.FEATURE,
                title="Parent Feature",
                product=product_name,
                agent="tester",
            )
            c1 = create_item(
                item_type=ItemType.TASK,
                title="Child One",
                product=product_name,
                agent="tester",
                parent=parent.id,
            )
            c2 = create_item(
                item_type=ItemType.TASK,
                title="Child Two",
                product=product_name,
                agent="tester",
                parent=parent.id,
            )
    
            started = update_state(
                item_ref=c1.id,
                new_state=ItemState.IN_PROGRESS,
                agent="tester",
                model="unit-test",
                product=product_name,
                sync_parent=True,
                refresh_dashboards=False,
            )
            assert started.parent_synced is True
            parent_after_start = get_item(parent.id, product=product_name)
            assert parent_after_start.state == ItemState.IN_PROGRESS
            assert any("Auto parent sync:" in line for line in parent_after_start.worklog)
    
            first_done = update_state(
                item_ref=c1.id,
                new_state=ItemState.DONE,
                agent="tester",
                model="unit-test",
                product=product_name,
                sync_parent=True,
                refresh_dashboards=False,
            )
            assert first_done.parent_synced is False
            parent_mid = get_item(parent.id, product=product_name)
            assert parent_mid.state == ItemState.IN_PROGRESS
    
>           second_done = update_state(
                item_ref=c2.id,
                new_state=ItemState.DONE,
                agent="tester",
                model="unit-test",
                product=product_name,
                sync_parent=True,
                refresh_dashboards=True,
            )

tests\test_workitem_ops.py:171: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src\kano_backlog_ops\workitem.py:461: in update_state
    view.refresh_dashboards(agent=agent, backlog_root=target_root, product=None)
src\kano_backlog_ops\view.py:105: in refresh_dashboards
    content = _render_dashboard(
src\kano_backlog_ops\view.py:271: in _render_dashboard
    vcs_meta = detect_vcs_metadata(workspace_root)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\kano_backlog_core\vcs\detector.py:20: in detect_vcs_metadata
    return adapter.get_metadata(repo_root)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <kano_backlog_core.vcs.null_adapter.NullAdapter object at 0x0000020E63C686E0>
repo_root = WindowsPath('C:/Users/User/AppData/Local/Temp/pytest-of-dorgon.chang/pytest-54/test_update_state_syncs_parent0')

    def get_metadata(self, repo_root: Path) -> VcsMeta:
        """Return unknown metadata."""
>       return VcsMeta(
            provider="none",
            branch="unknown",
            revno="unknown",
            hash="unknown",
            dirty="unknown"
        )
E       TypeError: VcsMeta.__init__() got an unexpected keyword argument 'branch'

src\kano_backlog_core\vcs\null_adapter.py:16: TypeError
============================== warnings summary ===============================
tests/test_config_migration.py::test_migrate_json_dry_run_leaves_files_untouched
  C:\Python314\Lib\site-packages\typer\main.py:706: DeprecationWarning: JSON config is deprecated; migrate to TOML: C:\Users\User\AppData\Local\Temp\pytest-of-dorgon.chang\pytest-54\test_migrate_json_dry_run_leav0\_kano\backlog\_shared\defaults.json
    return callback(**use_params)

tests/test_config_migration.py::test_migrate_json_dry_run_leaves_files_untouched
  C:\Python314\Lib\site-packages\typer\main.py:706: DeprecationWarning: JSON config is deprecated; migrate to TOML: C:\Users\User\AppData\Local\Temp\pytest-of-dorgon.chang\pytest-54\test_migrate_json_dry_run_leav0\_kano\backlog\products\demo\_config\config.json
    return callback(**use_params)

tests/test_config_migration.py::test_migrate_json_writes_toml_and_backup
  C:\Python314\Lib\site-packages\typer\main.py:706: DeprecationWarning: JSON config is deprecated; migrate to TOML: C:\Users\User\AppData\Local\Temp\pytest-of-dorgon.chang\pytest-54\test_migrate_json_writes_toml_0\_kano\backlog\_shared\defaults.json
    return callback(**use_params)

tests/test_config_migration.py::test_migrate_json_writes_toml_and_backup
  C:\Python314\Lib\site-packages\typer\main.py:706: DeprecationWarning: JSON config is deprecated; migrate to TOML: C:\Users\User\AppData\Local\Temp\pytest-of-dorgon.chang\pytest-54\test_migrate_json_writes_toml_0\_kano\backlog\products\demo\_config\config.json
    return callback(**use_params)

tests/test_config_migration.py::test_migrate_json_skips_when_toml_exists[True]
  C:\Python314\Lib\site-packages\typer\main.py:706: DeprecationWarning: JSON config is deprecated; migrate to TOML: C:\Users\User\AppData\Local\Temp\pytest-of-dorgon.chang\pytest-54\test_migrate_json_skips_when_t0\_kano\backlog\_shared\defaults.json
    return callback(**use_params)

tests/test_config_migration.py::test_migrate_json_skips_when_toml_exists[False]
  C:\Python314\Lib\site-packages\typer\main.py:706: DeprecationWarning: JSON config is deprecated; migrate to TOML: C:\Users\User\AppData\Local\Temp\pytest-of-dorgon.chang\pytest-54\test_migrate_json_skips_when_t1\_kano\backlog\_shared\defaults.json
    return callback(**use_params)

tests/test_config_migration.py::test_migrate_json_skips_when_toml_exists[False]
  C:\Python314\Lib\site-packages\typer\main.py:706: DeprecationWarning: JSON config is deprecated; migrate to TOML: C:\Users\User\AppData\Local\Temp\pytest-of-dorgon.chang\pytest-54\test_migrate_json_skips_when_t1\_kano\backlog\products\demo\_config\config.json
    return callback(**use_params)

tests/test_config_toml.py::test_json_loads_when_no_toml
  D:\_work\_Kano\kano-agent-backlog-skill-demo\skills\kano-agent-backlog-skill\src\kano_backlog_core\config.py:327: DeprecationWarning: JSON config is deprecated; migrate to TOML: C:\Users\User\AppData\Local\Temp\pytest-of-dorgon.chang\pytest-54\test_json_loads_when_no_toml0\_kano\backlog\_shared\defaults.json
    return ConfigLoader._read_config_optional(backlog_root / "_shared", "defaults")

tests/test_config_toml.py::test_deep_merge_toml_and_json
  D:\_work\_Kano\kano-agent-backlog-skill-demo\skills\kano-agent-backlog-skill\src\kano_backlog_core\config.py:169: DeprecationWarning: JSON config is deprecated; migrate to TOML: C:\Users\User\AppData\Local\Temp\pytest-of-dorgon.chang\pytest-54\test_deep_merge_toml_and_json0\_kano\backlog\products\prod\_config\config.json
    return ConfigLoader._read_config_optional(product_root / "_config", "config")

tests/test_workitem_ops.py: 30 warnings
  C:\Python314\Lib\site-packages\frontmatter\__init__.py:161: DeprecationWarning: codecs.open() is deprecated. Use open() instead.
    with codecs.open(fd, "r", encoding) as f:

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=============================== tests coverage ================================
_______________ coverage: platform win32, python 3.14.2-final-0 _______________

Name                                        Stmts   Miss  Cover   Missing
-------------------------------------------------------------------------
src\kano_backlog_core\__init__.py               9      0   100%
src\kano_backlog_core\audit.py                 53     37    30%   33-39, 52-57, 79-95, 112-134
src\kano_backlog_core\backend_uri.py           84      8    90%   25, 49, 103, 107, 114, 127, 132, 148
src\kano_backlog_core\canonical.py            168     96    43%   18, 66, 70-71, 107-108, 121-180, 198-237, 253, 270-307, 337, 355, 361-376, 382-385
src\kano_backlog_core\config.py               197     24    88%   32-36, 81, 88-93, 101-102, 107, 132, 163, 202, 226, 258, 275, 281-282, 301
src\kano_backlog_core\derived.py              132     90    32%   15-25, 43-50, 54-70, 87, 92, 97, 102, 107, 112, 117, 122, 140-144, 148-161, 165, 169-172, 176, 180, 184-193, 197, 201, 205, 209-213, 217-227, 236-240
src\kano_backlog_core\errors.py                51     25    51%   29-30, 37-39, 46-48, 64-67, 74-76, 86-87, 94-97, 113-116
src\kano_backlog_core\models.py                67     10    85%   104-112, 116-118
src\kano_backlog_core\refs.py                 137    108    21%   29-33, 43-47, 52-54, 65-92, 106-107, 124-135, 147-155, 167-170, 174-191, 195-215, 219-236, 240-256, 265-274
src\kano_backlog_core\state.py                 53     40    25%   62, 88-123, 142-164
src\kano_backlog_core\vcs\__init__.py           4      0   100%
src\kano_backlog_core\vcs\base.py              14      0   100%
src\kano_backlog_core\vcs\detector.py          26     14    46%   13, 23, 33-47
src\kano_backlog_core\vcs\git_adapter.py       26     19    27%   17-68
src\kano_backlog_core\vcs\null_adapter.py       7      0   100%
-------------------------------------------------------------------------
TOTAL                                        1028    471    54%
Coverage HTML written to dir htmlcov
=========================== short test summary info ===========================
FAILED tests/test_cli_item_create.py::test_item_create_creates_file_and_uses_config_prefix
FAILED tests/test_workitem_ops.py::test_update_state_syncs_parent_and_refreshes_dashboards
=========== 2 failed, 109 passed, 39 warnings in 119.07s (0:01:59) ============
