#!/bin/bash
# Git commit-msg hook: Gentle reminder to create/update backlog items
# Install: git config core.hooksPath .githooks
#
# This is a SOFT reminder - commits always proceed.
# To disable: git config kano.backlog.reminders false

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Check if reminders are disabled
REMINDERS_ENABLED=$(git config --get kano.backlog.reminders)
if [ "$REMINDERS_ENABLED" = "false" ]; then
    exit 0
fi

# Check if commit message has a backlog item ID
if echo "$COMMIT_MSG" | grep -qE "KABSD-(FTR|TSK|BUG|USR|EPC)-[0-9]+"; then
    # Has ticket ID - all good
    exit 0
fi

# Check if this is a trivial commit (docs, typo, formatting)
if echo "$COMMIT_MSG" | grep -qiE "^(docs|chore|style|typo|format):"; then
    # Trivial commit - no ticket needed
    exit 0
fi

# Check if this is a merge/revert commit
if echo "$COMMIT_MSG" | grep -qE "^(Merge|Revert)"; then
    exit 0
fi

# Check if this is a WIP commit
if echo "$COMMIT_MSG" | grep -qiE "^(WIP|wip):"; then
    # WIP commits don't need tickets yet
    exit 0
fi

# No ticket ID found - show gentle reminder
echo ""
echo "ðŸ’¡ Backlog Reminder (optional)"
echo ""
echo "   This commit doesn't have a backlog item ID."
echo "   Consider creating one to track your work:"
echo ""
echo "   kano-backlog item create --type task --title \"...\""
echo ""
echo "   Or disable these reminders:"
echo "   git config kano.backlog.reminders false"
echo ""
echo "   (Commit will proceed - this is just a reminder)"
echo ""

# Always allow commit to proceed
exit 0
fi

# Check if commit message has a backlog item ID
if echo "$COMMIT_MSG" | grep -qE "KABSD-(FTR|TSK|BUG|USR|EPC)-[0-9]+"; then
    # Has ticket ID - all good
    exit 0
fi

# Check if this is a trivial commit (docs, typo, formatting)
if echo "$COMMIT_MSG" | grep -qiE "^(docs|chore|style|typo|format):"; then
    # Trivial commit - no ticket needed
    exit 0
fi

# Check if this is a merge/revert commit
if echo "$COMMIT_MSG" | grep -qE "^(Merge|Revert)"; then
    exit 0
fi

# Check if this is a WIP commit
if echo "$COMMIT_MSG" | grep -qiE "^(WIP|wip):"; then
    # WIP commits don't need tickets yet
    exit 0
fi

# No ticket ID found - show gentle reminder
echo ""
echo "ðŸ’¡ Backlog Reminder (optional)"
echo ""
echo "   This commit doesn't have a backlog item ID."
echo "   Consider creating one to track your work:"
echo ""
echo "   kano-backlog item create --type task --title \"...\""
echo ""
echo "   Or disable these reminders:"
echo "   git config kano.backlog.reminders false"
echo ""
echo "   (Commit will proceed - this is just a reminder)"
echo ""

# Always allow commit to proceed
exit 0
